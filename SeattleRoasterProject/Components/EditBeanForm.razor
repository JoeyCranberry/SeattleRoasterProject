@inject IJSRuntime JSRuntime
@inject BeanService beanServ

<div class="modal fade" id="editBeanModal" tabindex="-1" aria-labelledby="editBeanModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header my-0 py-1">
				<h1 class="modal-title fs-5" id="exampleModalLabel">Edit Bean</h1>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>

			<EditForm Model="@editBean">
				<div class="modal-body">
					<!-- Basic Info -->
					<div class="row mb-2">
						<div class="col-2">
							<label for="inBeanId" class="form-label">ID</label>
							<InputText id="inBeanId" @bind-Value="editBean.Id" placeholder="0" class="form-control" disabled="true" />
						</div>
						<div class="col-10">
							<label for="inName" class="form-label">Name</label>
							<InputText id="inName" @bind-Value="editBean.FullName" placeholder="Roasters Inc." class="form-control" />
						</div>
					</div>

					<div class="row mb-3">
						<div class="col-6">
							<label for="inRoasterMongoId" class="form-label">Roaster Mongo Id</label>
							<InputSelect id="inProcessingMethods" @bind-Value="editBean.MongoRoasterId" class="form-select w-100">
								@foreach (var roaster in Roasters.OrderBy(c => c.ToString()))
								{
									<option value="@roaster.Value.Id">@roaster.Value.Name</option>
								}
							</InputSelect>
						</div>
						<div class="col-6">
							<label for="inProductURL" class="form-label">Product URL</label>
							<div class="d-flex justify-content-between">
								<InputText id="inProductURL" @bind-Value="editBean.ProductURL" placeholder="0" class="form-control w-80" />
								<a href="@editBean.ProductURL" class="btn btn-primary" target="_blank"><span class="bi bi-box-arrow-up-right"></span></a>
							</div>
						</div>
					</div>

					<!-- Image links -->

					<div class="row">
						<div class="col-4 rounded px-0 ms-3 bean-image-preview">
							<img class="rounded h-100 @editBean.ImageClass" src="@editBean.ImageURL" />
						</div>
						<div class="col-7">
							<label for="inImageURL" class="form-label pt-2">Image URL</label>
							<InputText id="inImageURL" @bind-Value="editBean.ImageURL" placeholder="https://www.roastersite.com/image.png" class="form-control" />

							<label for="inImageClass" class="form-label pt-2">Image Class</label>
							<InputText id="inImageClass" @bind-Value="editBean.ImageClass" placeholder="bg-light" class="form-control" />
						</div>
					</div>

					<hr class="mb-1" />

					<!-- Processing, Roast, Organic Cert, and Price -->
					<div class="row">
						<div class="col-4">
							<label for="inProcessingMethods" class="form-label pt-2">Processes</label>

							<ul class="list-group ms-0">
								@if (editBean.ProcessingMethods == null)
								{
									<li class="list-group-item px-0 d-flex justify-content-between">
										<InputSelect id="inProcessingMethods" @bind-Value="newProcess" class="form-select w-80">
											@foreach (var process in Enum.GetValues<ProccessingMethod>().OrderBy(c => c.ToString()))
											{
												<option value="@process">@BeanModel.GetProcessDisplayName(process)</option>
											}
										</InputSelect>

										<button class="btn btn-success px-1" @onclick="AddProcess"><span class="bi bi-plus text-white"></span></button>
									</li>
								}
								else
								{
									@foreach (var process in editBean.ProcessingMethods)
									{
										<li class="list-group-item px-0 d-flex justify-content-between">
											<div class="form-control bg-disabled w-80">
												@BeanModel.GetProcessDisplayName(process)
											</div>

											<button class="btn btn-danger px-1" @onclick="@(e => RemoveProcess(process))">
												<span class="bi bi-dash text-white"></span>
											</button>
										</li>
									}
									<li class="list-group-item px-0 d-flex justify-content-between">
										<InputSelect id="inProcessingMethods" @bind-Value="newProcess" class="form-select w-80">
											@foreach (var process in Enum.GetValues<ProccessingMethod>().Where(c => !editBean.ProcessingMethods.Contains(c)).OrderBy(c => c.ToString()))
											{
												<option value="@process">@BeanModel.GetProcessDisplayName(process)</option>
											}
										</InputSelect>
										<button class="btn btn-success px-1" @onclick="AddProcess">
											<span class="bi bi-plus text-white"></span>
										</button>
									</li>
								}
							</ul>
						</div>

						<div class="col-5">
							<label for="inOrganic" class="form-label pt-2">Organic</label>
							<InputSelect id="inOrganic" @bind-Value="editBean.OrganicCerification" class="form-select">
								@foreach (var cerification in Enum.GetValues<OrganicCerification>().OrderBy(e => e.ToString()))
								{
									<option value="@cerification">@BeanModel.GetOrganicCertificationDisplayName(cerification)</option>
								}
							</InputSelect>
						</div>

						<div class="col-3">
							<label for="inRoastLevel" class="form-label pt-2">Roast</label>
							<InputSelect id="inRoastLevel" @bind-Value="editBean.RoastLevel" class="form-select">
								@foreach (var level in Enum.GetValues<RoastLevel>().OrderBy(e => BeanModel.GetRoastOrder(e)))
								{
									<option value="@level">@BeanModel.GetRoastDisplayName(level)</option>
								}
							</InputSelect>
						</div>
					</div>

					<div class="row">
						<div class="col-3">
							<label for="inPrice" class="form-label pt-2">Price</label>
							<InputNumber id="inPrice" @bind-Value="editBean.PriceBeforeShipping" placeholder="0.00" class="form-control" />
						</div>
						<div class="col-3">
							<label for="inSizeOz" class="form-label pt-2">Size (Oz)</label>
							<InputNumber id="inSizeOz" @bind-Value="editBean.SizeOunces" placeholder="0.00" class="form-control" />
						</div>
					</div>

					<!-- Bool checboxes -->
					<div class="row">
						<div class="col">
							<InputCheckbox id="inDecaf" @bind-Value="editBean.IsDecaf"></InputCheckbox>
							<label for="inDecaf" class="form-label pt-2"><span class="bi bi-eraser-fill pe-1"></span> Decaf</label>
						</div>
						<div class="col">
							<InputCheckbox id="inSingleOrigin" @bind-Value="editBean.IsSingleOrigin"></InputCheckbox>
							<label for="inSingleOrigin" class="form-label pt-2"><span class="bi bi-signpost-fill pe-1"></span>Single Origin</label>
						</div>
					</div>

					<hr class="mb-1" />

					<div class="row">
						<div class="col">
							<InputCheckbox id="inFairTrade" @bind-Value="editBean.IsFairTradeCertified"></InputCheckbox>
							<label for="inFairTrade" class="form-label pt-2 pe-2"><span class="bi bi-cash pe-1"></span>Fair Trade</label>

							<InputCheckbox id="inAboveFairTrade" @bind-Value="editBean.IsAboveFairTradePricing"></InputCheckbox>
							<label for="inAboveFairTrade" class="form-label pt-2"><span class="bi bi-cash-stack pe-1"></span>Above FT</label>
						</div>
						<div class="col">
							<InputCheckbox id="inDirectTrade" @bind-Value="editBean.IsDirectTradeCertified"></InputCheckbox>
							<label for="inDirectTrade" class="form-label pt-2"><span class="bi bi-people-fill pe-1"></span>Direct Trade</label>
						</div>
					</div>

					<div class="row">
						<div class="col">
							<InputCheckbox id="inWomanOwnedFarms" @bind-Value="editBean.IsFromWomanOwnedFarms"></InputCheckbox>
							<label for="inWomanOwnedFarms" class="form-label pt-2"><span class="bi bi-gender-female pe-1"></span>Woman-owned Farms</label>
						</div>
						<div class="col">
							<InputCheckbox id="inRainForestCertified" @bind-Value="editBean.IsRainforestAllianceCertified"></InputCheckbox>
							<label for="inRainForestCertified" class="form-label pt-2"><span class="bi bi-tree-fill pe-1"></span>Rainforest Certified</label>
						</div>
					</div>

					<div class="row">
						<div class="col-4">
							<InputCheckbox id="inSupportingCause" @bind-Value="editBean.IsSupportingCause"></InputCheckbox>
							<label for="inSupportingCause" class="form-label pt-2"><span class="bi bi-bag-heart-fill pe-1"></span>Support Cause</label>
						</div>
						@if (editBean.IsSupportingCause)
						{
							<div class="col-8">
								<label for="inSupportedCause" class="form-label pt-2">Cause</label>
								<InputText id="inSupportedCause" @bind-Value="editBean.SupportedCause" class="form-control"></InputText>
							</div>
						}
					</div>

					<hr class="mb-1" />

					<div class="row">
						<div class="col">
							<InputCheckbox id="inAvailablePreground" @bind-Value="editBean.AvailablePreground"></InputCheckbox>
							<label for="inAvailablePreground" class="form-label pt-2"><span class="bi bi-fan pe-1"></span>Available Preground</label>
						</div>
					</div>

					<div class="row">
						<div class="col">
							<InputCheckbox id="inExcluded" @bind-Value="editBean.IsExcluded"></InputCheckbox>
							<label for="inExcluded" class="form-label pt-2"><span class="bi bi-x-octagon-fill pe-1"></span>Excluded</label>
						</div>
						<div class="col">
							<InputCheckbox id="inInStock" @bind-Value="editBean.InStock"></InputCheckbox>
							<label for="inInStock" class="form-label pt-2"><span class="bi bi-box-seam-fill pe-1"></span>In Stock</label>
						</div>
					</div>

					<!-- Countries of Origin -->
					<div class="row">
						<div class="col-6">
							<label for="inRegionsOfOrigin" class="form-label pt-2">Regions</label>
							<InputText id="inRegionsOfOrigin" @bind-Value="editBean.RegionsOfOrigin" placeholder="Yiracheffe, Guji" class="form-control" />
						</div>
						<div class="col-6">
							<div class="row">
								<div class="col">
									<InputCheckbox id="inHasProducerName" @bind-Value="editBean.HasProducerInfo"></InputCheckbox>
									<label for="inHasProducerName" class="form-label pt-2"><span class="bi bi-check-all pe-1"></span>Producer Info</label>
								</div>
							</div>
							<div class="row">
								<div class="col">
									<InputCheckbox id="inHasImporterName" @bind-Value="editBean.HasImporterName"></InputCheckbox>
									<label for="inHasImporterName" class="form-label pt-2"><span class="bi bi-building-down pe-1"></span>Importer</label>
								</div>
								<div class="col">
									<InputCheckbox id="inHasProcessorName" @bind-Value="editBean.HasProcessorName"></InputCheckbox>
									<label for="inHasProcessorName" class="form-label pt-2"><span class="bi bi-sun pe-1"></span>Processor</label>
								</div>
							</div>
						</div>
					</div>

					<div class="row">
						<div class="col-6">
							<label for="inCountryOfOrigin" class="form-label pt-2">Origin Countries</label>

							<ul class="list-group">
								@if (editBean.CountriesOfOrigin == null)
								{
									<li class="list-group-item px-0 bg-coffee d-flex justify-content-between">
										<InputSelect id="inCountriesOfOrigin" @bind-Value="newCountry" class="form-select w-85">
											@foreach (var country in Enum.GetValues<SourceCountry>().OrderBy(c => c.ToString()))
											{
												<option value="@country">@BeanModel.GetCountryDisplayName(country)</option>
											}
										</InputSelect>

										<button class="btn btn-success px-1" @onclick="AddCountry"><span class="bi bi-plus text-white"></span></button>
									</li>
								}
								else
								{
									@foreach (var country in editBean.CountriesOfOrigin)
									{
										<li class="list-group-item px-0 bg-coffee d-flex justify-content-between">
											<div class="form-control bg-disabled w-85">
												@BeanModel.GetCountryDisplayName(country)
											</div>

											<button class="btn btn-danger px-1" @onclick="@(e => RemoveCountry(country))">
												<span class="bi bi-dash text-white"></span>
											</button>
										</li>
									}
									<li class="list-group-item px-0 bg-coffee d-flex justify-content-between">
										<InputSelect id="inCountriesOfOrigin" @bind-Value="newCountry" class="form-select w-85">
											@foreach (var country in Enum.GetValues<SourceCountry>().Where(c => !editBean.CountriesOfOrigin.Contains(c)).OrderBy(c => c.ToString()))
											{
												<option value="@country">@BeanModel.GetCountryDisplayName(country)</option>
											}
										</InputSelect>
										<button class="btn btn-success px-1" @onclick="AddCountry">
											<span class="bi bi-plus text-white"></span>
										</button>
									</li>
								}
							</ul>
						</div>
						<div class="col-6">
							<!--Continents of Origin-->
							<label for="inContinentsOfOrigin" class="form-label pt-2">Origin Continents</label>

							<ul class="list-group">
								@if (editBean.ContinentsOfOrigin == null)
								{
									<li class="list-group-item px-0 bg-coffee d-flex justify-content-between">
										<InputSelect id="inContinentsOfOrigin" @bind-Value="newContinent" class="form-select w-85">
											@foreach (var continent in Enum.GetValues<SourceContinent>().OrderBy(c => c.ToString()))
											{
												<option value="@continent">@BeanModel.GetContinentDisplayName(continent)</option>
											}
										</InputSelect>

										<button class="btn btn-success px-1" @onclick="AddContinent"><span class="bi bi-plus text-white"></span></button>
									</li>
								}
								else
								{
									@foreach (var continent in editBean.ContinentsOfOrigin)
									{
										<li class="list-group-item px-0 bg-coffee d-flex justify-content-between">
											<div class="form-control bg-disabled">
												@BeanModel.GetContinentDisplayName(continent)
											</div>

											<button class="btn btn-danger px-1" @onclick="@(e => RemoveContinent(continent))">
												<span class="bi bi-dash text-white"></span>
											</button>
										</li>
									}
									<li class="list-group-item px-0 bg-coffee d-flex justify-content-between">
										<InputSelect id="inContinentsOfOrigin" @bind-Value="newContinent" class="form-select w-90">
											@foreach (var continent in Enum.GetValues<SourceContinent>().Where(c => !editBean.ContinentsOfOrigin.Contains(c)).OrderBy(c => c.ToString()))
											{
												<option value="@continent">@BeanModel.GetContinentDisplayName(continent)</option>
											}
										</InputSelect>
										<button class="btn btn-success px-1" @onclick="AddContinent">
											<span class="bi bi-plus text-white"></span>
										</button>
									</li>
								}
							</ul>
						</div>
					</div>
					
					<div class="row">
						
						<div class="col-6">
							<label for="inRecommendedBrewMethods" class="form-label pt-2">Recommended Methods</label>

							<ul class="list-group ms-0">
								@if (editBean.RecommendingBrewMethods == null)
								{
									<li class="list-group-item px-0 d-flex justify-content-between">
										<InputSelect id="inRecommendedBrewMethods" @bind-Value="newMethod" class="form-select w-80">
											@foreach (var method in Enum.GetValues<BrewMethod>().OrderBy(c => c.ToString()))
											{
												<option value="@method">@BeanModel.GetBrewMethodDisplayName(method)</option>
											}
										</InputSelect>

										<button class="btn btn-success px-1" @onclick="AddMethod"><span class="bi bi-plus text-white"></span></button>
									</li>
								}
								else
								{
									@foreach (var method in editBean.RecommendingBrewMethods)
									{
										<li class="list-group-item px-0 d-flex justify-content-between">
											<div class="form-control bg-disabled w-80">
												@BeanModel.GetBrewMethodDisplayName(method)
											</div>

											<button class="btn btn-danger px-1" @onclick="@(e => RemoveMethod(method))">
												<span class="bi bi-dash text-white"></span>
											</button>
										</li>
									}
									<li class="list-group-item px-0 d-flex justify-content-between">
										<InputSelect id="inRecommendedBrewMethods" @bind-Value="newMethod" class="form-select w-80">
											@foreach (var method in Enum.GetValues<BrewMethod>().Where(c => !editBean.RecommendingBrewMethods.Contains(c)).OrderBy(c => c.ToString()))
											{
												<option value="@method">@BeanModel.GetBrewMethodDisplayName(method)</option>
											}
										</InputSelect>
										<button class="btn btn-success px-1" @onclick="AddMethod">
											<span class="bi bi-plus text-white"></span>
										</button>
									</li>
								}
							</ul>
						</div>


						<!-- Tasting Notes -->
						<div class="col-6">
							<label for="inTastingNotes" class="form-label pt-2">Tasting Notes</label>

							<ul class="list-group">
								@if (editBean.TastingNotes == null)
								{
									<li class="list-group-item px-0 bg-coffee d-flex justify-content-between">
										<InputText id="inTastingNotes" @bind-Value="newTastingNote" placeholder="Peaches, Milk Chocolate" class="form-control w-85">

										</InputText>

										<button class="btn btn-success px-1" @onclick="AddTastingNote"><span class="bi bi-plus text-white"></span></button>
									</li>
								}
								else
								{
									@foreach (string note in editBean.TastingNotes)
									{
										<li class="list-group-item px-0 bg-coffee d-flex justify-content-between">
											<div class="form-control bg-disabled w-85">
												@note
											</div>

											<button class="btn btn-danger px-1" @onclick="@(e => RemoveTastingNote(note))">
												<span class="bi bi-dash text-white"></span>
											</button>
										</li>
									}

									<li class="list-group-item px-0 bg-coffee d-flex justify-content-between">
										<InputText id="inTastingNotes" @bind-Value="newTastingNote" placeholder="Peaches, Milk Chocolate" class="form-control w-85">

										</InputText>
										<button class="btn btn-success px-1" @onclick="AddTastingNote">
											<span class="bi bi-plus text-white"></span>
										</button>
									</li>
								}
							</ul>
						</div>
					</div>

					<DataAnnotationsValidator />
					<ValidationSummary />
				</div>
				<div class="modal-footer">
					<button type="submit" class="btn btn-danger px-1" @onclick="DeleteBean">
						<div class="spinner-border spinner-border-sm d-none" role="status">
							<span class="visually-hidden">Loading...</span>
						</div>
						<span class="bi bi-trash pe-2"></span>
						Delete
					</button>

					<button type="button" class="btn btn-primary" @onclick="UpdateBean">
						<div class="spinner-border spinner-border-sm d-none" role="status">
							<span class="visually-hidden">Loading...</span>
						</div>
						<span class="bi bi-pencil pe-2"></span>
						Save Changes
					</button>
				</div>
			</EditForm>
		</div>
	</div>
</div>
@code {
	[Parameter]
	public EventCallback<string> OnBeanUpdated { get; set; }
	[Parameter]
	public EventCallback<string> OnBeanDeleted { get; set; }
	[Parameter]
	public Dictionary<string, RoasterModel> Roasters { get; set; }

	private BeanModel? originalBean;
	private BeanModel editBean = new BeanModel();

	private SourceCountry newCountry;
	private SourceContinent newContinent;
	private ProccessingMethod newProcess;
	private BrewMethod newMethod;

	private string newTastingNote;

	private bool editIsWorking = false;
	private bool deleteIsWorking = false;

	public async Task EditBean(BeanModel bean)
	{
		originalBean = bean;
		editBean = bean;
		StateHasChanged();

		await ShowEditModal();
	}

	private async Task ShowEditModal()
	{
		await JSRuntime.InvokeVoidAsync("ShowModal", "#editBeanModal");
	}

	private async Task HideEditModal()
	{
		await JSRuntime.InvokeVoidAsync("HideModal", "#editBeanModal");
	}

	#region Updating List Properties
	/*
	* Process
	*/
	private void AddProcess()
	{
		if (editBean.ProcessingMethods == null)
		{
			editBean.ProcessingMethods = new List<ProccessingMethod>();
		}

		editBean.ProcessingMethods.Add(newProcess);
	}

	private void RemoveProcess(ProccessingMethod delProcess)
	{
		editBean.ProcessingMethods.Remove(delProcess);
	}

	/*
	* Brew Methods
	*/
	private void AddMethod()
	{
		if (editBean.RecommendingBrewMethods == null)
		{
			editBean.RecommendingBrewMethods = new List<BrewMethod>();
		}

		editBean.RecommendingBrewMethods.Add(newMethod);
	}

	private void RemoveMethod(BrewMethod delMethod)
	{
		editBean.RecommendingBrewMethods.Remove(delMethod);
	}

	/*
	* Country
	*/
	private void AddCountry()
	{
		if (editBean.CountriesOfOrigin == null)
		{
			editBean.CountriesOfOrigin = new List<SourceCountry>();
		}

		editBean.CountriesOfOrigin.Add(newCountry);
	}

	private void RemoveCountry(SourceCountry delCountry)
	{
		editBean.CountriesOfOrigin.Remove(delCountry);
	}

	/*
	* Tasting Notes
	*/
	private void AddTastingNote()
	{
		if (editBean.TastingNotes == null)
		{
			editBean.TastingNotes = new List<string>();
		}

		List<string> split = newTastingNote
			.ToLower()
			.Replace("and ", ", ")
			.Replace("& ", ", ")
			.Replace("  ", " ")
			.Replace(" | ", ", ")
			.Trim()
			.Split(",")
			.Where(s => !String.IsNullOrEmpty(s))
			.ToList();

		editBean.TastingNotes.AddRange(split);
		newTastingNote = "";
	}

	private void RemoveTastingNote(string delTastingNote)
	{
		editBean.TastingNotes.Remove(delTastingNote);
	}

	/*
	* Continent
	*/
	private void AddContinent()
	{
		if (editBean.ContinentsOfOrigin == null)
		{
			editBean.ContinentsOfOrigin = new List<SourceContinent>();
		}

		editBean.ContinentsOfOrigin.Add(newContinent);
	}

	private void RemoveContinent(SourceContinent delContinent)
	{
		editBean.ContinentsOfOrigin.Remove(delContinent);
	}
	#endregion

	private async Task DeleteBean()
	{
		await beanServ.DeleteBean(editBean);
		await OnBeanDeleted.InvokeAsync(editBean.FullName);

		ResetFields();

		await HideEditModal();
	}

	private async Task UpdateBean()
	{
		await beanServ.UpdateExistingBean(editBean);
		await OnBeanUpdated.InvokeAsync(editBean.FullName);

		ResetFields();

		await HideEditModal();
	}

	private void ResetFields()
	{
		editBean = new BeanModel();
		originalBean = null;
		newTastingNote = String.Empty;
		newCountry = SourceCountry.UNKNOWN;
	}
}
